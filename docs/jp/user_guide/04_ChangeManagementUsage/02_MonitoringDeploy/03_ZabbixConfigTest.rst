作業検証
========

監視設定後の検証を行います。

大きく、監視仕様とZabbixコンソール画面の「目視確認」作業と、
Getconfig インベントリ収集ツールを用いた「インベントリ収集」作業の
2つに分かれます。

   .. figure:: image/01_overview.png
      :align: center
      :alt: Overview
      :width: 720px

各手順を以下に記します。

目視確認
--------

目視確認は代表的な監視設定パターンをピックアップし、
Zabbix コンソールから目視で確認する手順となります。
従来の手動での確認手順と同様となり概要は以下の通りです。

- 監視仕様書から監視対象サーバの監視設定パターンを分類します。

   + 主に「DB サーバ」と 「処理サーバ」にパターン分類します
   + その他、ストレージやサーバで異なる監視パターンがある場合は
     それぞれ分類します

- 分類した中から代表のサーバをピックアップします。
- Zabbix コンソールからピックアップしたサーバの設定と、 監視仕様との差異を目視で確認します。
- 差異がないことを確認したら、画面のスクリーンショットを採取して確認エビデンスを保存します。 

インベントリ収集プロジェクトセットアップ
----------------------------------------

.. note::

   新しい環境にてインベントリ収集をする場合、初回にインベントリ収集プロジェクトを作成します。
   後述の作業用 PC 以外の別環境でインベントリ収集をする場合は、以下の手順でプロジェクトを作成
   してください。後述の作業用 PC を利用する場合は本手順はスキップし、次節の
   :ref:`inventory_collect` から進めてください。

プロジェクト作成
~~~~~~~~~~~~~~~~

PowerShell コンソールから、「getconfig -g <プロジェクト名>」でプロジェクトを作成します。

::

   cd C:\Users\Administrator\Desktop
   getconfig -g zabbix_test

実行後、デスクトップ上に、「zabbix_test」というディレクトリが作成されます。
本ディレクトリが、Zabbix監視設定のインベントリ収集を行うプロジェクトホームで、
本ディレクトリの下で、作業を行います。

検査シート編集
~~~~~~~~~~~~~~

「cd <プロジェクト名>」でプロジェクトホームに移動してください。

::

   cd zabbix_test

初めに検査シートを編集します。
Zabbix 監視設定の検査シートは、「.\\template\\Zabbix」の下にある以下の
Excelファイルで、本ファイルをプロジェクトホーム直下にコピーします。

::

   cp .\template\Zabbix\Zabbix監視設定チェックシート.xlsx .

インベントリ収集をする際は本Excelをコピーして、検査対象の設定などシナリオの編集をします。
本Excelを開いて、シート「検査対象」を選択します。
4～6行目に予行演習モードデモ用の設定がされているので、「検査ドメイン」以降の列を削除してください。
削除が終了したらExcelを保存して、終了してください。

config.groovy 編集
~~~~~~~~~~~~~~~~~~

次に、「.\\template\\Zabbix」の下の config_zabbix.groovy を .\\config\\config.groovy にコピーします。

::

   cp .\template\Zabbix\config_zabbix.groovy .\config\config.groovy

.\\config\\config.groovy は、getconfig コマンド実行時の設定ファイルの既定パスとなります。
本ファイルを サクラエディタなど UTF-8に対応した、エディタで開きます。 

::

   sakura .\config\config.groovy

最終行以降に、以下の行を追加し、Zabbixサーバの接続情報を追加します。

::

   account.Zabbix.Test1.server   = '{ZabbixサーバIP}'
   account.Zabbix.Test1.user     = 'Admin'
   account.Zabbix.Test1.password = 'zabbix'

以降のインベントリ収集作業は本プロジェクトホーム下で実行してください。

.. _inventory_collect:

インベントリ収集
----------------

Zabbix の監視設定情報を Getconfig インベントリ収集ツールを用いて収集します。
収集した結果と先ほどの「目視確認」で確認した代表サーバの設定との差異をチェックします。
差異があった箇所について、監視仕様と比較して妥当性を確認します。

作業用PCに接続
~~~~~~~~~~~~~~

Getconfig 作業用PC にadministrator ユーザでリモートデスクトップ接続します。

プロジェクトホーム移動
~~~~~~~~~~~~~~~~~~~~~~

スタートメニューから PowerShell を起動して、コンソールを開きます。
Zabbix 監視設定収集用の Getconfig プロジェクトディレクトリ
「C:\\users\\administrator\\Desktop\\zabbix_monitor_setup」に移動します。

::

   cd C:\users\administrator\Desktop\zabbix_monitor_setup

検査シート作成
~~~~~~~~~~~~~~

プロジェクトディレクトリ下にある、「Zabbix監視設定チェックシート.xlsx」をコピーして
検査用 Excel ファイルを作成します。
ここでは、例としてY6APCQDC用のシートを作成します。

::

   copy .\Zabbix監視設定チェックシート.xlsx 構成管理DB監視設定_Zabbix監視設定チェックシート.xlsx

ファイル名は作業名が分かるようにしてください。
ここでは、「構成管理DB監視設定_Zabbix監視設定チェックシート.xlsx」とします。

検査シート編集
~~~~~~~~~~~~~~

コピーした Excel ファイルを開き、 シート「検査対象」を編集します。

シート「検査対象」を選択して、検査対象のホストのリストを入力します

以下の通りシートを記入してください。

   * 「検査ドメイン」列

      - 固定で「Zabbix」と入力してください

   * 「対象サーバ」列

      - 検査対象のサーバ名を入力します。Zabbixで定義したホスト名を入力してください

   * 「ユーザID」列

      - 前述の config.groovy で定義したZabbixサーバ接続定義のIDを指定してください
      - ここでは、前述で作成した Test1 を記述します

   * 「テンプレートID」列

      - 固定で「Zabbix」と入力してください

   * 「エイリアス」列

      - 入力せずに空白のままにしてください

   * 「比較対象」列

      - 設定値の比較をする対象サーバを入力してください
      - 比較対象サーバは、サーバ分類の中の代表サーバで、Zabbix で目視確認をしたサーバを指定してください。

Getconfig インベントリ収集実行
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

getconfig コマンドを用いてインベントリ収集を実行します。
PowerShell コンソールからプロジェクトホームに移動し、
「getconfig --excel {作成した 検査シートファイル名}」オプションを指定して実行してください。

.. note::

   予行演習モードで実行する場合は、以下の通り「-d」オプションを追加して実行します。
   Zabbix サーバへのアクセスはせずに、前回のインベントリ収集の実行で、
   ローカルディスクに保存されたログから収集を行います

   ::

      cd C:\Users\Administrator\Desktop\zabbix_test
      getconfig -e .\構成管理DB監視設定_Zabbix監視設定チェックシート.xlsx

Excel 実行結果の各シートの確認
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

実行結果は、「build」ディレクトリ下に作成されます。

ファイル名が、「Zabbix監視設定チェックシート_{日付}_{時刻}.xlsx」となる直近に生成された
Excel が実行結果となり、本 Excel を開いて結果を確認します。

* シート「検査レポート」

   - 全体のサマリとなり、各ホストのステータス、検査の成績、エラー項目を記載しています。
     ホストステータスは以下4項目を記載しています。

      + 「ステータス」
        Zabbixエージェントステータスが有効か
      + 「利用可能」
        Zabbixエージェントが利用可能か
      + 「Syslog監視」
        シスログ監視が利用可能か
      + 「トリガー」
        トリガーにエラーがないか

* シート「エラーレポート」

   - 検査結果のエラーメッセージのリストとなります

* シート「チェックシート(Zabbix)」

   - 各ホストの検査結果となり、次のセクションで確認手順を記します。


チェックシート(Zabbix)の確認
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

シート「チェックシート(Zabbix)」を選択します。

G列以降がインベントリ収集結果となります。
先頭列は比較対象としたホストの監視設定情報となります。

その後の列が各サーバの設定情報となり、比較対象との差異を色分けして表示しています。

- 水色のセル

   + 比較対象の値と差異がなかった箇所となり、「Same as '{比較対象ホスト}'」の表示となります。

- 白色のセル

   + 比較対象の値と差異があった箇所となり、値を表示しています。

- 緑色のセル

   + 検査ルールに記した検索条件にヒットした箇所となり、設定値が正しいことを記しています。主にステータス確認に使用し、「Monitored」、「Available」などのキーワードにヒットしたセルとなります。

- ピンク色のセル

   + 検査ルールに記した検索条件にヒットしなかった箇所となり、設定値にエラーがあることを記しています。

白色のセルとピンク色のセルは比較結果に相違がある、もしくは検査ルールにヒットしなかったセルとなり、
これら値は監視仕様書と比較し、目視で値の妥当性を確認します。

実行結果のコミット
~~~~~~~~~~~~~~~~~~

実行結果を確定するために「getconfig -u local」コマンドを実行してください。

::

   getconfig -u local

最終行に「Archive log from './build/log' to './src/test/resources/log/'」と表示されれば OK です。


まとめ
~~~~~~

「目視確認」と「インベントリ収集」で設定値の確認ができたら、以下エビデンスをまとめて結果を報告します。

* 目視確認結果

   - 代表サーバの監視設定のZabbixコンソールスクリーンショット

* インベントリ収集結果

   - Excel インベントリ収集結果

